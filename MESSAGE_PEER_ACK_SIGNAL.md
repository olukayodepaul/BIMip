## âœ… MessagePeerAckSignal

The `MessagePeerAckSignal` is the primary acknowledgment signal. It is generated by the server and sent back to the original message sender. It conveys the delivery status and the **Shared Message Anchor** (`peer_offset`).

### Protobuf Definition

```protobuf
message MessagePeerAckSignal {
  Identity to = 1;
  Identity from = 2;
  string message_id = 3;
  int32 method = 4;
  int64 timestamp = 5;
  int32 status_code = 6;
  Peer peer = 7;
  int64 offset = 8;  // Local physical offset for the Sender
}

```

---

### ðŸ”„ The Anchor-Offset Logic (Shared Reference)

In this architecture, the `peer_offset` acts as the **Global Pointer** for a specific message within a conversation. Regardless of which user is looking at the message, the `peer_offset` remains the same: the **Sender's Offset**.

#### How the Mirror Works:

If **User A** sends a message that the server assigns to User A's **Offset 5**:

1. **For User A (Sender):** * The `offset` is **5**.
* The `peer.peer_offset` is **5**.
* *Meaning:* "This is my 5th message, and I've anchored it at index 5."


2. **For User B (Receiver):**
* The local `offset` might be **102** (the physical position in B's log).
* The `peer.peer_offset` is **5**.
* *Meaning:* "This is my 102nd message overall, but it is **Message #5 from User A**."



---

### ðŸ“ Logic Visualization (Shared Anchor Model)

| Entity | `offset` (Physical Pos) | `peer.to` | `peer.peer_offset` (The Anchor) |
| --- | --- | --- | --- |
| **Sender (A)** | **5** | EID of B | **5** |
| **Receiver (B)** | **102** | EID of A | **5** |

> **Architecture Note:** While the Receiver has their own local `offset` (102), it is used only for physical file seeking. For all **logical conversation tracking**, the `peer_offset` (5) is the only ID used by both parties.

---

### ðŸ“˜ Field Reference

| Tag | Field Name | Type | Description | Role |
| --- | --- | --- | --- | --- |
| **1** | `to` | `Identity` | The **original message sender** (who receives this ACK). | Routing |
| **2** | `from` | `Identity` | The **server or recipient** identity issuing the acknowledgment. | Routing |
| **3** | `message_id` | `string` | The **ID of the specific `Message**` being acknowledged. | Reference |
| **4** | `method` | `int32` | Operation code (1 = REQUEST, 2 = RESPONSE). | Status |
| **5** | `timestamp` | `int64` | Time the acknowledgment was generated (Epoch milliseconds). | Status |
| **6** | `status_code` | `int32` | **Status code** (e.g., 200 = Success, 409 = Duplicate). | Status |
| **7** | `peer` | `Peer` | **Synchronization Data**. Contains the `peer_offset` and the cross-referenced `to` identity. | Sync |
| **8** | `offset` | `int64` | **Sender Offset**. The message's unique index in the sender's own history. | Sync |

---
