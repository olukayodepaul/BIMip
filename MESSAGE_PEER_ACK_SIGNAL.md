## ‚úÖ MessagePeerAckSignal

The `MessagePeerAckSignal` is the primary acknowledgment signal. It is generated by the server and sent back to the original message sender. It conveys the delivery status and, critically, the **server-generated stream state** via the `Peer` object and the sender's own stream `offset`.

### Protobuf Definition

```protobuf
message MessagePeerAckSignal {
  Identity to = 1;
  Identity from = 2;
  string message_id = 3;
  int32 method = 4;
  int64 timestamp = 5;
  int32 status_code = 6;
  Peer peer = 7;
  int64 offset = 8;  // The sender's global stream offset
}

```

### Field Reference

| Tag | Field Name | Type | Description | Role |
| --- | --- | --- | --- | --- |
| **1** | `to` | `Identity` | The **original message sender** (who receives this ACK). | Routing |
| **2** | `from` | `Identity` | The **server or recipient** identity issuing the acknowledgment. | Routing |
| **3** | `message_id` | `string` | The **ID of the specific `Message**` being acknowledged. | Reference |
| **4** | `method` | `int32` | Operation code (1 = REQUEST, 2 = RESPONSE). | Status |
| **5** | `timestamp` | `int64` | Time the acknowledgment was generated (Epoch milliseconds). | Status |
| **6** | `status_code` | `int32` | **Status code** (e.g., 200 = Success, 409 = Duplicate). | Status |
| **7** | `peer` | `Peer` | **Synchronization Data**. Contains the recipient's assigned `peer_offset`. | Sync |
| **8** | `offset` | `int64` | **Sender Offset**. The message's unique index in the sender's own history. | Sync |

---

### üîÑ Dual-Offset Synchronization Logic

The `MessagePeerAckSignal` provides the client with two distinct points of truth. This allows the sender to know exactly where the message sits in both their own history and the recipient's history.

* **`offset` (Field 8):** This is the incremented counter for the **Sender**. When the sender receives this, they update their local database to mark the message as "Persisted" at this specific index.
* **`peer.peer_offset` (Inside Field 7):** This is the incremented counter for the **Recipient**. The sender stores this to track exactly where this message landed in the other person's inbox, ensuring zero-gap synchronization.

---

### üìù Example Usage (Elixir)

```elixir
# Building the ACK response after a successful Mnesia/File write
ack_signal = %Bimip.MessagePeerAckSignal{
  to: sender_identity,
  from: server_identity,
  message_id: "vcNAQcDoIIB4TCCAd0CAQAxggE2MIIBMgIddd",
  status_code: 200,
  offset: 15,          # User A's offset
  peer: %Bimip.Peer{
    to: "b@domain.com",
    peer_offset: 82    # User B's offset
  },
  timestamp: System.system_time(:millisecond)
}

```

