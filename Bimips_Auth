user = "a@domain.com"
total_messages = 50_000
batch_size = 1_000

IO.puts "ğŸš€ Starting stress test: #{total_messages} messages..."

Enum.each(1..total_messages, fn i ->
  # Generate a unique ID for every message
  unique_id = :crypto.strong_rand_bytes(16) |> Base.encode64()
  
  msg = %Chat.MessageStruct{
    peer_uid: unique_id,
    timestamp: System.system_time(:millisecond),
    payload: "Stress test message ##{i}",
    payload_context: 1,
    encryption_type: "E2E",
    encrypted: "DATA_#{i}",
    signature: "SIG_#{i}",
    device_id: "aaaaa1",
    uupid: "1",
    eid: user,
    from: %Chat.EntityStruct{eid: user, connection_resource_id: "aaaaa1"},
    to: %Chat.EntityStruct{eid: "b@domain.com", connection_resource_id: nil}
  }

  # Write to Shard 18
  Queue.QueueLogImpl.write(1, user, "b@domain.com", "1", 1, 1, msg, unique_id)

  # Log progress every 5000 messages
  if rem(i, 5000) == 0, do: IO.puts "âœ… Written #{i} messages..."
end)

IO.puts "ğŸ Load test complete. Waiting for flush..."
