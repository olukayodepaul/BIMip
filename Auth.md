# BIMIP Login & Token Authentication

## Overview

BIMIP uses **JWT (JSON Web Token)**–based authentication for client login and session validation.
Tokens are **generated by `BimipServer`** and consumed by clients during login and subsequent authenticated communication.

This document explains:

* How BIMIP login works
* JWT structure and claims
* How tokens are registered and used internally
* The roles of `Bimip.SignalServer` and `Bimip.SignalClient`
* Device identification (`uupid` vs `device_id`)

---

## High-Level Login Flow

1. **Client requests login** from `BimipServer`
2. **BimipServer generates a JWT access token**
3. Client sends the token when connecting/authenticating
4. Token claims are validated
5. Device and user session are registered in:

   * `Bimip.SignalServer` (mother GenServer)
   * `Bimip.SignalClient` (per-device GenServer)
6. Client is allowed into the system (queues, signaling, messaging)

---

## Example JWT Token

```
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

Decoded payload:

```json
{
  "aud": "Joken",
  "device_id": "bbbbb4",
  "eid": "b@domain.com",
  "exp": 1767802758,
  "iat": 1767716358,
  "iss": "Joken",
  "jti": "32431ad6bverp94ke4000023",
  "nbf": 1767716358,
  "type": "access",
  "uupid": "4"
}
```

---

## JWT Claims Explanation

| Claim       | Description                                                                      |
| ----------- | -------------------------------------------------------------------------------- |
| `aud`       | Audience. Identifies the token consumer (BIMIP uses `Joken`).                    |
| `iss`       | Issuer. Token issuer (`Joken` via `BimipServer`).                                |
| `type`      | Token type. Currently `access`.                                                  |
| `eid`       | **Entity ID** – logical user identifier (e.g. email or JID).                     |
| `device_id` | **Unique device identifier** for tracking a physical/logical device.             |
| `uupid`     | **Unique numeric device ID** used internally for **queue indexing and routing**. |
| `jti`       | Unique token ID (prevents replay attacks).                                       |
| `iat`       | Issued-at timestamp.                                                             |
| `nbf`       | Not-before timestamp.                                                            |
| `exp`       | Expiration timestamp.                                                            |

---

## Device Identity Model

BIMIP separates **tracking identity** from **queue identity**.

### `device_id`

* String-based identifier
* Used for:

  * Device tracking
  * Analytics
  * Multi-device ownership
* Stable across sessions

### `uupid`

* Numeric identifier
* Used for:

  * Queue placement
  * Fast lookup
  * High-performance routing
* Optimized for internal storage and internal indexing

> **Rule:** One `device_id` maps to exactly one `uupid` at runtime.

---

## Token Registration Lifecycle

### 1. Token Issuance (BimipServer)

* Token is generated using **RSA (RS256)**
* Claims are embedded (`eid`, `device_id`, `uupid`)
* Token is signed and returned to client

### 2. Token Validation

* Client presents token on connect
* Signature verification is optional (configurable)
* Claims are decoded and validated:

  * `exp`, `nbf`, `type`
  * Required identifiers

### 3. Registration in `Bimip.SignalServer`

* `Bimip.SignalServer` acts as the **mother GenServer**
* Responsibilities:

  * Registers active sessions
  * Maps `eid` → device processes
  * Tracks connected devices

### 4. Client Device Process

* Each device is supervised under:

  * `Bimip.SignalClient`
* One GenServer per device
* Registered using:

  * `eid`
  * `device_id`
  * `uupid`

---

## Internal Architecture Mapping

```
Client
  │
  │ JWT Token
  ▼
BimipServer
  │ (issues token)
  ▼
Bimip.SignalServer (Mother GenServer)
  │
  ├── Registry (eid → pid)
  ├── internal storage (uupid → queue slot)
  │
  └── Bimip.SignalClient
        └── Client GenServer (per device)
```

---

## JWT Signature Verification (Optional)

BIMIP supports **optional signature verification**.

* Algorithm: `RS256`
* Public key may be:

  * Pre-configured locally
  * Injected manually

> Note: `iss = "Joken"` is **not a URL**, therefore automatic public key discovery is disabled.

Manual verification requires explicitly providing the public key.

---

## Security Notes

* Tokens are **time-bound** (`exp`, `nbf`)
* `jti` ensures uniqueness per token
* Device-level isolation via GenServers
* Queue operations rely on numeric `uupid` for performance

---

## Summary

* BIMIP login is **token-based (JWT)**
* Tokens are generated by `BimipServer`
* Sessions are registered in `Bimip.SignalServer`
* Each device runs in an isolated `Bimip.SignalClient` GenServer
* `device_id` = tracking identity
* `uupid` = queue and routing identity

